<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€“ Grievance Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { background-color:#121212; color:#e0e0e0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    .card { background-color:#1e1e1e; border:1px solid #333; }
    .card-header { background: linear-gradient(135deg,#ff6a00 0%,#ee0979 100%); color:white; }
    .form-control, .form-select { background-color:#2d2d2d !important; border:1px solid #555 !important; color:#e0e0e0 !important; }
    .form-control::placeholder { color:#aaa !important; }
    .small-label { font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:#bdbdbd; }

    .badge-priority-high { background:#ff5252; }
    .badge-priority-medium { background:#ffb300; color:#121212; }
    .badge-priority-low { background:#66bb6a; }
    .badge-urgent { background:#ff1744; }

    .grievance-row { border-bottom:1px solid #333; padding:0.75rem 0; cursor:pointer; }
    .grievance-row:last-child { border-bottom:none; }

    #map { height:320px; border-radius:6px; border:1px solid #333; overflow:hidden; margin-bottom:12px; }

    /* DETAIL MODAL (floating panel) */
    #grievance-detail-modal {
      position: fixed;
      right: 18px;
      top:72px;
      width:420px;
      max-width: calc(100% - 36px);
      background:#141414;
      color:#e6e6e6;
      border:1px solid #2f2f2f;
      border-radius:8px;
      z-index:9999;
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
      display:none;
      padding:14px;
      max-height:80vh;
      overflow-y:auto;
    }

    #grievance-detail-modal.center {
      position: fixed !important;
      left: 50% !important;
      top: 50% !important;
      right: auto !important;
      transform: translate(-50%, -50%) !important;
      width: min(900px, 90%);
      max-width: calc(100% - 40px);
      max-height: 90vh;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    }

    /* SUMMARY PANEL */
    #summaryPanel {
      position: fixed;
      right: -380px;
      top: 50%;
      transform: translateY(-50%);
      width: 380px;
      height: 85vh;
      background: linear-gradient(180deg,#0f1724,#071023);
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: -8px 10px 40px rgba(2,8,23,0.7);
      z-index: 12000;
      color:#e6eef8;
      border-radius: 10px 0 0 10px;
      overflow-y: auto;
      transition: right .35s ease;
      padding: 12px;
    }
    #summaryPanel.open { right: 0; }

    /* Floating summary button */
    #summaryBtn {
      position: fixed;
      bottom: 22px;
      right: 22px;
      width: 60px;
      height: 60px;
      border-radius:50%;
      background: linear-gradient(135deg,#ff6a00 0%,#ee0979 100%);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      border: none;
      z-index: 13000;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    #summaryBtn svg { width:28px; height:28px; fill:white; }

    #dashboardWrap { transition: margin-right .35s ease; }
    #dashboardWrap.shifted { margin-right: 280px; }

    @media (max-width:900px) {
      #grievance-detail-modal.center {
        left: 4% !important;
        right: 4% !important;
        top: 64px !important;
        transform: none !important;
        width: 92% !important;
        max-height: 65vh;
        border-radius: 10px;
      }
      #summaryPanel { width: 92%; left:4%; right:4%; top: 64px; transform: none; height: 60vh; border-radius:10px; }
      #dashboardWrap.shifted { margin-right: 0; }
    }
  </style>

  <!-- Firebase libs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>

<body data-bs-theme="dark">

  <div class="container-fluid mt-3" id="dashboardWrap">
    <div class="row justify-content-center">
      <div class="col-xl-10 col-lg-11">

        <div class="card shadow">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-0">Admin Dashboard</h4>
              <small class="text-light-50">AI-powered grievance prioritization</small>
            </div>

            <div>
              <span id="adminEmail" class="me-3 small"></span>
              <button id="signOutBtn" class="btn btn-sm btn-outline-light" style="display:none;" onclick="_admin.signOut()">Sign Out</button>
            </div>
          </div>

          <div class="card-body">

            <!-- SIGN IN -->
            <div id="adminLoginSection">
              <h5 class="mb-3">Admin Sign In</h5>

              <div class="row g-2">
                <div class="col-md-4">
                  <input type="email" id="adminEmailInput" class="form-control" placeholder="Admin email">
                </div>

                <div class="col-md-4">
                  <input type="password" id="adminPasswordInput" class="form-control" placeholder="Password">
                </div>

                <div class="col-md-4 d-grid">
                  <button class="btn btn-primary" onclick="_admin.login()">Sign In as Admin</button>
                </div>
              </div>

              <p class="mt-2 small text-muted">(Use an email added to Firebase Auth + ADMIN_EMAILS list.)</p>
            </div>

            <!-- DASHBOARD SECTION -->
            <div id="dashboardSection" style="display:none;">

              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <label class="small-label mb-1">Priority</label>
                  <select id="priorityFilter" class="form-select" onchange="onFilterChange()">
                    <option value="all">All</option>
                    <option value="high">High only</option>
                    <option value="medium">Medium only</option>
                    <option value="low">Low only</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="small-label mb-1">Category</label>
                  <select id="categoryFilter" class="form-select" onchange="onFilterChange()">
                    <option value="all">All</option>
                    <option value="roads">Roads</option>
                    <option value="water">Water</option>
                    <option value="electricity">Electricity</option>
                    <option value="sanitation">Sanitation</option>
                    <option value="health">Health</option>
                    <option value="governance">Governance</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="small-label mb-1">Status</label>
                  <select id="statusFilter" class="form-select" onchange="onFilterChange()">
                    <option value="all">All</option>
                    <option value="open">Open</option>
                    <option value="resolved">Resolved</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="small-label mb-1">Search</label>
                  <input id="searchInput" class="form-control" placeholder="Search title/description..." oninput="onFilterChange()">
                </div>
              </div>

              <!-- STATS -->
              <div class="row g-3 mb-3">
                <div class="col-md-3"><div class="p-3 rounded" style="background:#212121;"><div class="small-label">Total grievances</div><div id="statTotal" class="fs-4">0</div></div></div>
                <div class="col-md-3"><div class="p-3 rounded" style="background:#212121;"><div class="small-label">High priority open</div><div id="statHighOpen" class="fs-4">0</div></div></div>
                <div class="col-md-3"><div class="p-3 rounded" style="background:#212121;"><div class="small-label">Medium priority open</div><div id="statMediumOpen" class="fs-4">0</div></div></div>
                <div class="col-md-3"><div class="p-3 rounded" style="background:#212121;"><div class="small-label">Resolved</div><div id="statResolved" class="fs-4">0</div></div></div>
              </div>

              <!-- MAP -->
              <div class="mb-3">
                <h5 class="mb-0">Map</h5>
                <small class="text-muted">Markers reflect current filters</small>
                <div id="map"></div>
              </div>

              <!-- LIST -->
              <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Grievances</h5>
                  <small class="text-muted" id="listMeta"></small>
                </div>

                <div class="pagination-wrapper mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <label class="small-label me-2">Page size</label>
                    <select id="pageSizeSelect" class="form-select form-select-sm" style="width:110px" onchange="onPageSizeChange()">
                      <option value="5">5</option>
                      <option value="10" selected>10</option>
                      <option value="20">20</option>
                      <option value="50">50</option>
                    </select>
                  </div>

                  <div id="paginationButtons" class="d-flex align-items-center gap-1"></div>
                </div>

                <div id="grievanceList">
                  <div class="text-center text-muted py-5">Loading grievances...</div>
                </div>
              </div>

            </div>

            <div id="status" class="mt-3 text-center fw-bold"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- DETAIL FLOATING MODAL -->
  <div id="grievance-detail-modal" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
      <div style="flex:1;">
        <div id="gd-title" style="font-weight:700;font-size:1.05rem;margin-bottom:6px;word-break:break-word;"></div>
        <div id="gd-badges" style="margin-bottom:8px"></div>
      </div>
      <button id="gd-close" type="button" class="btn btn-sm" style="background:transparent;border:1px solid #3b3b3b;color:#e6e6e6;padding:6px 10px;border-radius:6px;cursor:pointer">Close</button>
    </div>

    <div id="gd-desc" style="color:#cfcfcf;margin-top:8px;margin-bottom:10px;white-space:pre-wrap;"></div>

    <div id="gd-meta" style="font-size:0.85rem;color:#bdbdbd;margin-bottom:8px"></div>

    <div id="gd-latlon" style="font-size:0.9rem;color:#dcdcdc;margin-bottom:12px"></div>

    <!-- explicit image container -->
    <div id="gd-image" style="display:none; text-align:center; margin-top:12px;"></div>

    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="gd-map-btn" style="background:#0b5;border:0;padding:8px 10px;border-radius:6px;color:#051;font-weight:600;cursor:pointer">Open on Map</button>
      <button id="gd-resolve-btn" style="background:transparent;border:1px solid #2f7f56;color:#a8ffc9;padding:8px 10px;border-radius:6px;cursor:pointer">Mark Resolved</button>
    </div>
  </div>

  <!-- SUMMARY PANEL -->
  <div id="summaryPanel">
    <div class="summary-header">
      <div class="summary-title">Summary</div>
    </div>
    <div id="clustersList" style="margin-top:10px;"></div>
  </div>

  <!-- FLOATING SUMMARY BUTTON -->
  <button id="summaryBtn" title="Open summary">
    <svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5
      c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 
      2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 
      1s-.45 1-1 1-1-.45-1-1 
      .45-1 1-1zm0 14H8v-2h4v2zm4-4H8v-2h8v2zm0-4H8V7h8v2z"/>
      <path d="M9 16l-2.5-2.5 1.4-1.4L9 
      13.2l3.1-3.1 1.4 1.4z"></path></svg>
  </button>

  <script src="./tfidf.js"></script>
  <script type="module" src="./admin_api.js"></script>
  <script type="module" src="./admin_ui.js"></script>


</body>
</html>
