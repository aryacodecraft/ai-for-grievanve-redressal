<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Grievance Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Custom Styles (illa.com-inspired) -->
  <style>
    :root {
      --primary-color: #ff6f00;
      --secondary-color: #0d47a1;
      --light-bg: #ffffff;
      --dark-text: #212121;
      --gray-text: #757575;
      --border-color: #e0e0e0;
    }

    body {
      background-color: var(--primary-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      margin: 0;
      color: var(--dark-text);
    }

    .container-wrapper {
      background: var(--light-bg);
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 1400px;
      margin: auto;
      position: relative;
    }

    .card-header {
      background: linear-gradient(135deg, #ff6a00 0%, #ee0979 100%) !important;
      color: white !important;
      padding: 1.25rem;
      border-radius: 10px !important;
      margin-bottom: 25px;
    }

    .card-header h4 {
      margin-bottom: 5px;
      font-weight: 600;
    }

    .form-control, .form-select {
      background-color: #fff !important;
      border: 1px solid #ddd !important;
      color: var(--dark-text) !important;
      padding: 0.6rem 0.9rem;
      border-radius: 8px;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 3px rgba(255, 111, 0, 0.1);
    }

    .form-control::placeholder {
      color: #aaa !important;
    }

    .badge-priority-high {
      background: #ff5252;
      color: white;
    }
    .badge-priority-medium {
      background: #ffb300;
      color: #121212;
    }
    .badge-priority-low {
      background: #66bb6a;
      color: white;
    }
    .badge-urgent {
      background: #ff1744;
      color: white;
    }

    .status-chip {
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-open {
      background: #ff9800;
      color: #121212;
    }
    .status-resolved {
      background: #4caf50;
      color: white;
    }

    .grievance-row {
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 0;
    }
    .grievance-row:last-child {
      border-bottom: none;
    }

    .small-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9e9e9e;
      font-weight: 600;
    }

    .stat-card {
      background: #fafafa;
      border-radius: 10px;
      padding: 1rem;
      border: 1px solid #eee;
    }

    .btn-outline-light {
      color: white;
      border-color: white;
    }

    .btn-outline-light:hover {
      background: white;
      color: var(--primary-color);
    }

    .btn-primary {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }
    .btn-primary:hover {
      background: #e65100;
      border-color: #e65100;
    }

    .btn-outline-success {
      color: #4caf50;
      border-color: #4caf50;
    }
    .btn-outline-success:hover {
      background: #4caf50;
      color: white;
    }

    .btn-outline-secondary {
      color: #757575;
      border-color: #ddd;
    }

    #status {
      margin-top: 1.5rem;
      font-weight: 600;
    }
    #status.text-success { color: #4caf50; }
    #status.text-danger { color: #f44336; }
    #status.text-warning { color: #ff9800; }

    /* Responsive */
    @media (max-width: 768px) {
      .container-wrapper {
        padding: 15px;
      }
      .card-header {
        padding: 1rem;
      }
    }
  </style>

  <!-- Firebase SDKs (unchanged) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container-wrapper">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-0">Admin Dashboard</h4>
          <small class="text-light">AI-powered grievance prioritization</small>
        </div>
        <div>
          <span id="adminEmail" class="me-3 text-white small"></span>
          <button class="btn btn-sm btn-outline-light" onclick="signOut()">Sign Out</button>
        </div>
      </div>

      <div class="card-body">

        <div id="adminLoginSection">
          <h5 class="mb-3">Admin Sign In</h5>
          <div class="row g-2">
            <div class="col-md-4">
              <input type="email" id="adminEmailInput" class="form-control" placeholder="Admin email">
            </div>
            <div class="col-md-4">
              <input type="password" id="adminPasswordInput" class="form-control" placeholder="Password">
            </div>
            <div class="col-md-4 d-grid">
              <button class="btn btn-primary" onclick="adminSignIn()">Sign In as Admin</button>
            </div>
          </div>
          <p class="mt-2 small text-muted">
            (Use an email that you’ve created in Firebase Auth and added to the ADMIN_EMAILS list in this page.)
          </p>
        </div>

        <div id="dashboardSection" style="display:none;">

          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <label class="small-label mb-1">Priority</label>
              <select id="priorityFilter" class="form-select" onchange="renderGrievances()">
                <option value="all">All</option>
                <option value="high">High only</option>
                <option value="medium">Medium only</option>
                <option value="low">Low only</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="small-label mb-1">Category</label>
              <select id="categoryFilter" class="form-select" onchange="renderGrievances()">
                <option value="all">All</option>
                <option value="roads">Roads</option>
                <option value="water">Water</option>
                <option value="electricity">Electricity</option>
                <option value="sanitation">Sanitation</option>
                <option value="health">Health</option>
                <option value="governance">Governance</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="small-label mb-1">Status</label>
              <select id="statusFilter" class="form-select" onchange="renderGrievances()">
                <option value="all">All</option>
                <option value="open">Open</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="small-label mb-1">Search (title / desc)</label>
              <input id="searchInput" class="form-control" placeholder="Search text..." oninput="renderGrievances()">
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <div class="stat-card">
                <div class="small-label mb-1">Total grievances</div>
                <div id="statTotal" class="fs-4 fw-bold">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <div class="small-label mb-1">High priority open</div>
                <div id="statHighOpen" class="fs-4 fw-bold">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <div class="small-label mb-1">Medium priority open</div>
                <div id="statMediumOpen" class="fs-4 fw-bold">0</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <div class="small-label mb-1">Resolved</div>
                <div id="statResolved" class="fs-4 fw-bold">0</div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Grievances</h5>
              <small class="text-muted" id="listMeta"></small>
            </div>
            <div id="grievanceList">
              <div class="text-center text-muted py-4">Loading grievances...</div>
            </div>
          </div>
        </div>

        <div id="status" class="mt-3 text-center fw-bold"></div>
      </div>
    </div>
  </div>

  <!-- Firebase logic (unchanged from your original) -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAWTsTs_NEav91LKQ5jLrVf3ojsLYAY4XI",
      authDomain: "grievance-redressal-syst-627d7.firebaseapp.com",
      projectId: "grievance-redressal-syst-627d7",
      storageBucket: "grievance-redressal-syst-627d7.firebasestorage.app",
      messagingSenderId: "47862331768",
      appId: "1:47862331768:web:423bb1a0ac46e259d1b08d",
      measurementId: "G-YX2Y3RFF3P"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const ADMIN_EMAILS = ["aryaadmin@gmail.com"];

    let grievances = [];
    let unsubscribe = null;

    auth.onAuthStateChanged(user => {
      if (!user) {
        document.getElementById("adminLoginSection").style.display = "block";
        document.getElementById("dashboardSection").style.display = "none";
        document.getElementById("adminEmail").innerText = "";
        if (unsubscribe) unsubscribe();
        return;
      }

      if (!ADMIN_EMAILS.includes(user.email)) {
        showStatus("❌ You are signed in, but not an admin.", "text-danger");
        auth.signOut();
        return;
      }

      document.getElementById("adminEmail").innerText = user.email;
      document.getElementById("adminLoginSection").style.display = "none";
      document.getElementById("dashboardSection").style.display = "block";
      showStatus("✅ Signed in as admin.", "text-success");

      if (unsubscribe) unsubscribe();

      const q = db.collection("grievances").orderBy("createdAt", "desc");
      unsubscribe = q.onSnapshot(snapshot => {
        grievances = [];
        snapshot.forEach(doc => {
          grievances.push({ id: doc.id, ...doc.data() });
        });
        renderStats();
        renderGrievances();
      }, err => {
        console.error("Grievance snapshot error:", err);
        showStatus("❌ Failed to load grievances.", "text-danger");
      });
    });

    async function adminSignIn() {
      const email = document.getElementById("adminEmailInput").value.trim();
      const password = document.getElementById("adminPasswordInput").value.trim();
      if (!email || !password) {
        return showStatus("⚠️ Enter email and password.", "text-warning");
      }
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (e) {
        console.error(e);
        showStatus("❌ " + e.message, "text-danger");
      }
    }

    function signOut() {
      auth.signOut();
    }

    function priorityWeight(p) {
      if (p === "high") return 3;
      if (p === "medium") return 2;
      return 1;
    }

    function renderStats() {
      const total = grievances.length;
      let highOpen = 0, medOpen = 0, resolved = 0;

      grievances.forEach(g => {
        const status = g.status || "open";
        const priority = g.hfEngine?.priority || "low";

        if (status === "resolved") {
          resolved++;
        } else {
          if (priority === "high") highOpen++;
          if (priority === "medium") medOpen++;
        }
      });

      document.getElementById("statTotal").innerText = total;
      document.getElementById("statHighOpen").innerText = highOpen;
      document.getElementById("statMediumOpen").innerText = medOpen;
      document.getElementById("statResolved").innerText = resolved;
    }

    function renderGrievances() {
      const listEl = document.getElementById("grievanceList");
      if (!grievances.length) {
        listEl.innerHTML = '<div class="text-center text-muted py-5">No grievances yet.</div>';
        document.getElementById("listMeta").innerText = "0 items";
        return;
      }

      const priorityFilter = document.getElementById("priorityFilter").value;
      const categoryFilter = document.getElementById("categoryFilter").value;
      const statusFilter = document.getElementById("statusFilter").value;
      const searchText = document.getElementById("searchInput").value.trim().toLowerCase();

      let filtered = grievances.filter(g => {
        const hf = g.hfEngine || {};
        const pr = (hf.priority || "low").toLowerCase();
        const cat = (hf.category || "other").toLowerCase();
        const st = (g.status || "open").toLowerCase();

        if (priorityFilter !== "all" && pr !== priorityFilter) return false;
        if (categoryFilter !== "all" && cat !== categoryFilter) return false;
        if (statusFilter !== "all" && st !== statusFilter) return false;

        if (searchText) {
          const textBlob = `${g.title || ""} ${g.description || ""}`.toLowerCase();
          if (!textBlob.includes(searchText)) return false;
        }

        return true;
      });

      filtered.sort((a, b) => {
        const pa = priorityWeight(a.hfEngine?.priority || "low");
        const pb = priorityWeight(b.hfEngine?.priority || "low");
        if (pa !== pb) return pb - pa;

        const da = a.createdAt?.toDate?.() || new Date(0);
        const db = b.createdAt?.toDate?.() || new Date(0);
        return db - da;
      });

      document.getElementById("listMeta").innerText = `${filtered.length} items`;

      let html = "";
      filtered.forEach(g => {
        const hf = g.hfEngine || {};
        const priority = (hf.priority || "low").toLowerCase();
        const category = (hf.category || "other").toLowerCase();
        const isUrgent = !!hf.isUrgent;
        const status = (g.status || "open").toLowerCase();

        const created = g.createdAt?.toDate?.() || new Date();
        const createdStr = created.toLocaleDateString() + " " + created.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

        let badgeClass = "badge-priority-low";
        if (priority === "high") badgeClass = "badge-priority-high";
        else if (priority === "medium") badgeClass = "badge-priority-medium";

        const urgentBadge = isUrgent
          ? `<span class="badge ms-1 badge-urgent">URGENT</span>`
          : "";

        const statusClass = status === "resolved" ? "status-resolved" : "status-open";

        const keywords = (hf.keywords || []).slice(0, 5).join(", ");

        html += `
          <div class="grievance-row">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="d-flex align-items-center mb-1">
                  <strong>${g.title || "Untitled"}</strong>
                  <span class="badge ms-2 ${badgeClass} text-uppercase">${priority || "low"}</span>
                  ${urgentBadge}
                  <span class="badge ms-2 bg-secondary text-uppercase">${category}</span>
                </div>
                <div class="mb-1 text-muted" style="font-size:0.95rem;">${g.description || ""}</div>
                <div class="small text-muted">
                  <span class="me-3"><span class="small-label">Created:</span> ${createdStr}</span>
                  <span class="me-3"><span class="small-label">User:</span> ${g.userId || "-"}</span>
                  ${keywords ? `<span class="small-label">Keywords:</span> ${keywords}` : ""}
                </div>
              </div>
              <div class="text-end">
                <div class="mb-2">
                  <span class="status-chip ${statusClass}">${status}</span>
                </div>
                ${status === "open" ? `
                  <button class="btn btn-sm btn-outline-success mb-1" onclick="markResolved('${g.id}')">
                    Mark Resolved
                  </button>
                ` : `
                  <button class="btn btn-sm btn-outline-secondary" disabled>Resolved</button>
                `}
              </div>
            </div>
          </div>
        `;
      });

      listEl.innerHTML = html || '<div class="text-center text-muted py-5">No grievances match these filters.</div>';
    }

    async function markResolved(id) {
      try {
        await db.collection("grievances").doc(id).update({
          status: "resolved"
        });
        showStatus("✅ Marked as resolved.", "text-success");
      } catch (e) {
        console.error(e);
        showStatus("❌ Failed to update status.", "text-danger");
      }
    }

    function showStatus(msg, className) {
      const el = document.getElementById("status");
      el.innerText = msg;
      el.className = `mt-2 text-center fw-bold ${className}`;
      setTimeout(() => {
        if (el.innerText === msg) el.innerText = "";
      }, 5000);
    }
  </script>
</body>
</html>